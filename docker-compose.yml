# Hypefury Multi-Client Scheduler
# Deploys via Hostinger VPS with Traefik

services:
  scheduler:
    image: node:20
    container_name: hypefury-scheduler
    restart: unless-stopped
    working_dir: /app
    expose:
      - "8080"
    environment:
      - NODE_ENV=production
      - PORT=8080
      - HF_API_KEY=${HF_API_KEY}
      - DATA_DIR=/app/data
    volumes:
      - scheduler_data:/app/data
    command: >
      sh -c '
        apt-get update && apt-get install -y git python3 make g++ curl &&
        if [ -d /app/repo/.git ]; then
          cd /app/repo && git pull origin main
        else
          git clone https://github.com/rileyvibecodes/hypefury-scheduler.git /app/repo
        fi &&
        cd /app/repo &&
        npm install --include=dev &&
        npx tsc &&
        mkdir -p /app/data &&
        node build/server.js
      '
    labels:
      - traefik.enable=true
      - traefik.http.routers.hypefury.rule=Host(`scheduler.srv1176124.hstgr.cloud`)
      - traefik.http.routers.hypefury.tls=true
      - traefik.http.routers.hypefury.entrypoints=web,websecure
      - traefik.http.routers.hypefury.tls.certresolver=mytlschallenge
      - traefik.http.services.hypefury.loadbalancer.server.port=8080
    networks:
      - root_default
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

volumes:
  scheduler_data:
    driver: local

networks:
  root_default:
    external: true
